"""
–ú–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –±–æ—Ç–∞ –≤ Telegram, –≤–∫–ª—é—á–∞—è:
- –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ (—Ä–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, —Ä–∞–±–æ—Ç–∞ —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞).
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á, —Ç–∞–∫–∏—Ö –∫–∞–∫ —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤, —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤, —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞.
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–æ—Ç–∞, –≤–∫–ª—é—á–∞—è —Ç–µ–∫—Å—Ç, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –¥—Ä—É–≥–∏–µ –≤–∏–¥—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.
- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.
- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏.
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –∏ —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ —á–µ—Ä–µ–∑ FSM (Finite State Machine) –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ aiogram.

–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
1. –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –¥–æ—Å—Ç—É–ø–Ω–∞—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
2. –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Ñ–∞–π–ª–æ–≤ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
3. –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫–∏.
4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º.
5. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –±–æ—Ç–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
"""

import sqlite3, asyncio, os, shutil, aiosqlite
from datetime import datetime
from aiogram import types
import io
import pandas as pd
from aiogram.enums.parse_mode import ParseMode
from aiogram.types import InlineKeyboardButton
from aiogram.types import CallbackQuery, BufferedInputFile
from aiogram.utils.keyboard import InlineKeyboardBuilder, ReplyKeyboardBuilder
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from datetime import datetime
from db.db import Database, get_server_ids_as_list
from aiogram.types.input_file import FSInputFile
from aiogram import Router, F
from aiogram.types import ContentType, Message
from aiogram.fsm.state import State, StatesGroup
import random
import string
import logging
import aiohttp
import json
from db.db import get_referral_info_by_code
from aiogram.types import InlineKeyboardMarkup

logger = logging.getLogger(__name__)

from log import logger
from admin.delete_clients import get_inactive_clients, delete_depleted_clients
from bot import bot
from client.add_client import login
from handlers.config import get_server_data
from admin.sub_check import scheduled_check_subscriptions, get_server_ids_as_list_for_days_left
from handlers.states import BroadcastState, AddPromoCodeState, ManagePromoCodeState, ManageServerGroupState
from buttons.admin import BUTTON_TEXTS
from admin.delete_clients import scheduled_delete_clients
from dotenv import load_dotenv
import os

load_dotenv()
ADMIN_IDS = list(map(int, os.getenv("ADMIN_IDS").split(",")))
USERSDATABASE = os.getenv("USERSDATABASE")
SERVEDATABASE = os.getenv("SERVEDATABASE")
DATABASE_PATH = os.getenv("DATABASE_PATH")
BACKUP_DIR = os.getenv("BACKUP_DIR")
router = Router()

@router.message(Command("get_chat_id"))
async def get_chat_id(message: types.Message):
    chat_id = message.chat.id
    await message.answer(f"Chat ID —ç—Ç–æ–≥–æ —á–∞—Ç–∞: `{chat_id}`", parse_mode="Markdown")

@router.callback_query(lambda query: query.data == "cancel_admin")
async def cancel_action(callback_query: types.CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–º–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏–π –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏."""
    data = await state.get_data()
    sent_message_id = data.get('sent_message_id')

    cancel_message = await bot.edit_message_text(
        chat_id=callback_query.message.chat.id,
        message_id=sent_message_id,
        text="‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ."
    )
    
    await asyncio.sleep(0.5)
    await bot.delete_message(
        chat_id=callback_query.message.chat.id,
        message_id=cancel_message.message_id
    )

    await state.clear()
    await callback_query.answer()

@router.message(Command("admin"))
async def admin_panel(message: types.Message):
    """–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    await message.delete()

    user_id = message.from_user.id
    username = message.from_user.username or "(–±–µ–∑ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)"

    if user_id not in ADMIN_IDS:
        logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: User ID: {user_id}, Username: {username}")
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏.")

    logger.info(f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {username} (ID: {user_id}) –æ—Ç–∫—Ä—ã–ª –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")

    keyboard = ReplyKeyboardBuilder()
    keyboard.row(
        types.KeyboardButton(text=BUTTON_TEXTS["broadcast"]),
        types.KeyboardButton(text=BUTTON_TEXTS["send_message"])
    )
    keyboard.row(
        types.KeyboardButton(text=BUTTON_TEXTS["add_promo_code"]),
        types.KeyboardButton(text=BUTTON_TEXTS["delete_promo_code"])
    )
    keyboard.row(
        types.KeyboardButton(text=BUTTON_TEXTS["delete_clients"])
    )
    keyboard.row(
        types.KeyboardButton(text=BUTTON_TEXTS["top_referrers"]),
        types.KeyboardButton(text=BUTTON_TEXTS["statistics"])
    )
    keyboard.row(
        types.KeyboardButton(text=BUTTON_TEXTS["work_with_servers"]),
        types.KeyboardButton(text=BUTTON_TEXTS["referrals"])
    )
    keyboard.row(
        types.KeyboardButton(text=BUTTON_TEXTS["days_sub"]),
        types.KeyboardButton(text=BUTTON_TEXTS["edit_users"])
    )
    keyboard.row(
        types.KeyboardButton(text=BUTTON_TEXTS["backup"]),
        types.KeyboardButton(text=BUTTON_TEXTS["restart_bot"])
    )
    await message.answer(
        "**–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞**\n\n",
        reply_markup=keyboard.as_markup(resize_keyboard=True),
        parse_mode="Markdown"
    )

@router.message(Command("referal"))
async def referal_command(message: types.Message):
    if message.from_user.id not in ADMIN_IDS:
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    keyboard = types.InlineKeyboardMarkup(inline_keyboard=[
        [types.InlineKeyboardButton(
            text="üìä –í—ã–≥—Ä—É–∑–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –≤ Excel",
            callback_data="export_referrals"
        )]
    ])

    await message.answer(
        "–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:\n\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã.",
        reply_markup=keyboard
    )




@router.callback_query(lambda c: c.data == "export_referrals")
async def export_referrals_handler(callback_query: types.CallbackQuery):
    await callback_query.answer("‚è≥ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–∞...", show_alert=False)

    try:
        async with aiosqlite.connect("users.db") as conn:
            cursor = await conn.execute("SELECT id, telegram_user FROM referal_tables")
            rows = await cursor.fetchall()

        if not rows:
            return await callback_query.message.answer("‚ùå –í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏.")

        df = pd.DataFrame(rows, columns=["ID", "Telegram User"])
        output = io.BytesIO()
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            df.to_excel(writer, index=False, sheet_name='Referrals')
        output.seek(0)

        file = BufferedInputFile(output.read(), filename="referal_tables.xlsx")
        await callback_query.message.answer_document(file)

    except Exception as e:
        await callback_query.message.answer(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: {e}")






class BroadcastState(StatesGroup):
    waiting_for_message = State()
    waiting_for_audience = State()  # –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏

@router.message(F.text == BUTTON_TEXTS["send_message"])
async def start_broadcast(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –≤—ã–±–æ—Ä–æ–º –∞—É–¥–∏—Ç–æ—Ä–∏–∏"""
    await message.delete()

    if message.chat.id not in ADMIN_IDS:
        await message.answer("‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return

    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
    audience_keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="–ü—Ä–æ–±–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞", callback_data="broadcast_audience:trial"),
            InlineKeyboardButton(text="–û–ø–ª–∞—á–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞", callback_data="broadcast_audience:paid")
        ],
        [
            InlineKeyboardButton(text="–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏", callback_data="broadcast_audience:no_sub"),
            InlineKeyboardButton(text="–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", callback_data="broadcast_audience:all")
        ],
        [
            InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_admin")
        ]
    ])

    sent_message = await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:",
        reply_markup=audience_keyboard
    )
    
    await state.update_data(sent_message_id=sent_message.message_id, chat_id=sent_message.chat.id)
    await state.set_state(BroadcastState.waiting_for_audience)

@router.callback_query(BroadcastState.waiting_for_audience, F.data.startswith("broadcast_audience:"))
async def select_audience(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏"""
    audience_type = callback.data.split(":")[1]
    await state.update_data(audience_type=audience_type)
    
    cancel_button = InlineKeyboardBuilder()
    cancel_button.add(
        InlineKeyboardButton(
            text=BUTTON_TEXTS["cancel"], callback_data="cancel_admin"
        )
    )

    await callback.message.edit_text(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —Ñ–∞–π–ª –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:",
        reply_markup=cancel_button.as_markup()
    )
    await state.set_state(BroadcastState.waiting_for_message)
    await callback.answer()

@router.message(F.content_type.in_({'text', 'photo', 'document', 'video', 'audio'}), BroadcastState.waiting_for_message)
async def universe_broadcast(message: Message, state: FSMContext):
    """–†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏"""
    data = await state.get_data()
    audience_type = data.get("audience_type", "all")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º SQL –∑–∞–ø—Ä–æ—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏
    if audience_type == "trial":
        query = "SELECT telegram_id FROM users WHERE has_trial = 1"
    elif audience_type == "paid":
        query = "SELECT telegram_id FROM users WHERE sum_my > 0"
    elif audience_type == "no_sub":
        query = "SELECT telegram_id FROM users WHERE has_trial = 0 AND sum_my = 0"
    else:  # all
        query = "SELECT telegram_id FROM users"

    async with aiosqlite.connect(USERSDATABASE) as conn:
        async with conn.cursor() as cursor:
            await cursor.execute(query)
            users_data = await cursor.fetchall()

    content_type = message.content_type

    if content_type == ContentType.TEXT and message.text == '‚ùå –û—Ç–º–µ–Ω–∞':
        await state.clear()
        await message.answer('–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞!')
        return

    await state.clear()
    
    audience_name = {
        "trial": "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –ø—Ä–æ–±–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π",
        "paid": "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π",
        "no_sub": "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏",
        "all": "–≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"
    }.get(audience_type, "–≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º")
    
    await message.answer(f'–ù–∞—á–∏–Ω–∞—é —Ä–∞—Å—Å—ã–ª–∫—É ({audience_name}) –Ω–∞ {len(users_data)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.')

    good_send, bad_send = await broadcast_message(
        users_data=users_data,
        text=message.text if content_type == ContentType.TEXT else None,
        photo_id=message.photo[-1].file_id if content_type == ContentType.PHOTO else None,
        document_id=message.document.file_id if content_type == ContentType.DOCUMENT else None,
        video_id=message.video.file_id if content_type == ContentType.VIDEO else None,
        audio_id=message.audio.file_id if content_type == ContentType.AUDIO else None,
        caption=message.caption,
        content_type=content_type
    )

    def pluralize_users(count):
        if 11 <= count % 100 <= 19:
            return "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
        if count % 10 == 1:
            return "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
        if 2 <= count % 10 <= 4:
            return "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
        return "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"

    await message.answer(
        f"–†–∞—Å—Å—ã–ª–∫–∞ ({audience_name}) –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\n"
        f"–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–∏–ª–æ: <b>{good_send}</b> {pluralize_users(good_send)}.\n"
        f"–ù–µ –ø–æ–ª—É—á–∏–ª–∏: <b>{bad_send}</b> {pluralize_users(bad_send)}.",
        parse_mode="HTML"
    )


async def broadcast_message(users_data, text=None, photo_id=None, document_id=None, video_id=None, audio_id=None, caption=None, content_type=None):
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
    """
    successful, failed = 0, 0

    for user in users_data:
        user_id = user[0]
        try:
            if content_type == ContentType.TEXT:
                await bot.send_message(user_id, text)
            elif content_type == ContentType.PHOTO:
                await bot.send_photo(user_id, photo_id, caption=caption)
            elif content_type == ContentType.DOCUMENT:
                await bot.send_document(user_id, document_id, caption=caption)
            elif content_type == ContentType.VIDEO:
                await bot.send_video(user_id, video_id, caption=caption)
            elif content_type == ContentType.AUDIO:
                await bot.send_audio(user_id, audio_id, caption=caption)

            successful += 1
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
            failed += 1

    return successful, failed

@router.message(F.text == BUTTON_TEXTS["broadcast"])
async def check_subscription_command(message: types.Message):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –∏—Ö –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É."""
    await message.delete()
    if message.from_user.id not in ADMIN_IDS:
        await message.answer("–£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return
    await scheduled_check_subscriptions()
    await message.answer("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")


@router.message(F.text == BUTTON_TEXTS["statistics"])
@router.message(Command("stats"))
async def show_statistics(message: types.Message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω ID."""
    await message.delete()

    if message.from_user.id not in ADMIN_IDS:
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.")
        return

    # –ü–æ–ª—É—á–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥—ã (/stats <telegram_id>)
    args = message.text.split()
    user_id = int(args[1]) if len(args) > 1 and args[1].isdigit() else None

    conn = sqlite3.connect(USERSDATABASE)
    cursor = conn.cursor()

    if user_id:
        cursor.execute(
            """
            SELECT telegram_link, telegram_id, referral_count, sum_my, sum_ref, entry_date
            FROM users WHERE telegram_id = ?
            """,
            (user_id,)
        )
        user_data = cursor.fetchone()

        if user_data:
            telegram_link, telegram_id, referral_count, sum_my, sum_ref, entry_date = user_data
            user_stats_text = (
                f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b>\n"
                "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                f"üë§ <b>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–µ–ª–µ–≥—Ä–∞–º:</b> {telegram_link or 'N/A'}\n"
                f"üÜî <b>Telegram ID:</b> <code>{telegram_id}</code>\n"
                f"üóì <b>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:</b> {entry_date or 'N/A'}\n\n"
                f"üë• <b>–†–µ—Ñ–µ—Ä–∞–ª–æ–≤:</b> {referral_count}\n"
                f"üí∞ <b>–ü–æ—Ç—Ä–∞—Ç–∏–ª —Å–∞–º:</b> {sum_my or 0} ‚ÇΩ\n"
                f"üí∏ <b>–†–µ—Ñ–µ—Ä–∞–ª—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏:</b> {sum_ref or 0} ‚ÇΩ\n"
            )
            await message.answer(user_stats_text, parse_mode=ParseMode.HTML, disable_web_page_preview=True)
        else:
            await message.answer("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.")

    else:
        # –û–±—â–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        cursor.execute("SELECT COUNT(*) FROM users")
        total_bot_users = cursor.fetchone()[0]

        cursor.execute("SELECT COUNT(*) FROM users WHERE sum_my != 0")
        total_bot_userssum = cursor.fetchone()[0]

        cursor.execute("SELECT COUNT(*) FROM user_emails")
        total_clients = cursor.fetchone()[0]

        cursor.execute("SELECT COUNT(*) FROM users WHERE has_trial = 1")
        users_with_trial = cursor.fetchone()[0]

        cursor.execute("SELECT COUNT(*) FROM users WHERE has_trial = 0 OR sum_my = 0")
        users_bez_podpiski = cursor.fetchone()[0]

        cursor.execute("SELECT COUNT(*) FROM users WHERE promo_code_usage > 0")
        users_with_promo = cursor.fetchone()[0]

        cursor.execute("SELECT SUM(referral_count) FROM users")
        total_referrals = cursor.fetchone()[0] or 0

        cursor.execute("SELECT MIN(entry_date), MAX(entry_date) FROM users")
        first_user_date, last_user_date = cursor.fetchone()

        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        stats_text = (
            "üìä <b>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            f"üë• <b>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞:</b> {total_bot_users}\n"
            f"üë• <b>–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ø–æ–¥–ø–∏—Å–æ–∫):</b> {total_bot_users}\n"
            f"üéÅ <b>–ü—Ä–æ–±–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏:</b> {users_with_trial}\n"
            f"üë• <b>–û–ø–ª–∞—á–µ–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏:</b> {total_bot_userssum}\n"
            f"üë• <b>–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏:</b> {users_bez_podpiski}\n"
            f"üè∑ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏:</b> {users_with_promo}\n\n"
            f"üë• <b>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:</b> {total_referrals}\n"
            f"üìà <b>–°—Ä–µ–¥–Ω–µ–µ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</b> {total_referrals / total_bot_users if total_bot_users else 0:.2f}\n"
            f"üóì <b>–ü–µ—Ä–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {first_user_date or 'N/A'}\n"
            f"üóì <b>–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {last_user_date or 'N/A'}\n\n"
        )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await message.answer(stats_text, parse_mode=ParseMode.HTML, disable_web_page_preview=True)

    # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    cursor.close()
    conn.close()


@router.message(F.text == BUTTON_TEXTS["top_referrers"])
@router.message(Command("top"))
async def show_top_referrers(message: types.Message):
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –∑–∞–ø—Ä–æ—Å–∏–ª —Ç–æ–ø —Ä–µ—Ñ–æ–≤–æ–¥–æ–≤")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    if message.from_user.id not in ADMIN_IDS:
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.")
        return

    await message.delete()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –ë–î
    if not os.path.exists(USERSDATABASE):
        logger.error("–§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω")
        await message.answer("‚ö†Ô∏è –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    try:
        conn = sqlite3.connect(USERSDATABASE)
        cursor = conn.cursor()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: {e}")
        await message.answer("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
        return

    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–∞–±–ª–∏—Ü–∞ users
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='users';")
        if not cursor.fetchone():
            await message.answer("‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ 'users' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return

        # –ó–∞–ø—Ä–æ—Å —Ç–æ–ø-100 —Ä–µ—Ñ–æ–≤–æ–¥–æ–≤
        cursor.execute("""
            SELECT 
                telegram_link, 
                telegram_id, 
                referral_count, 
                sum_my, 
                sum_ref 
            FROM users 
            WHERE referral_count > 0 
            ORDER BY referral_count DESC 
            LIMIT 100
        """)
        top_referrers = cursor.fetchall()

        if not top_referrers:
            await message.answer("ü§∑‚Äç‚ôÇÔ∏è –ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ä–µ—Ñ–æ–≤–æ–¥–∞.")
            return

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        text = "üèÜ <b>–¢–æ–ø-100 —Ä–µ—Ñ–æ–≤–æ–¥–æ–≤</b>\n"
        text += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"

        for i, (telegram_link, telegram_id, referral_count, sum_my, sum_ref) in enumerate(top_referrers, 1):
            link = telegram_link or f"<a href='tg://user?id={telegram_id}'>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {i}</a>"
            sum_my_display = sum_my or 0
            sum_ref_display = sum_ref or 0
            text += (
                f"{i}. {link} (<code>{telegram_id}</code>) ‚Äî "
                f"{referral_count} —Ä–µ—Ñ., "
                f"–ø–æ—Ç—Ä–∞—Ç–∏–ª {sum_my_display} ‚ÇΩ, "
                f"—Ä–µ—Ñ–µ—Ä–∞–ª—ã ‚Äî {sum_ref_display} ‚ÇΩ\n"
            )

        await message.answer(text, parse_mode=ParseMode.HTML, disable_web_page_preview=True)
        logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–æ–ø-100 —Ä–µ—Ñ–æ–≤–æ–¥–æ–≤ (–Ω–∞–π–¥–µ–Ω–æ: {len(top_referrers)})")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ —Ç–æ–ø–∞ —Ä–µ—Ñ–æ–≤–æ–¥–æ–≤: {e}", exc_info=True)
        await message.answer("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–ø–∞ —Ä–µ—Ñ–æ–≤–æ–¥–æ–≤.")

    finally:
        try:
            cursor.close()
            conn.close()
        except:
            pass


@router.message(F.text == BUTTON_TEXTS["delete_clients"])
async def cmd_delete_clients(message: types.Message):
    await message.delete()
    if message.from_user.id not in ADMIN_IDS:
        await message.answer("–£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return

    await message.answer("üîÑ –ù–∞—á–∏–Ω–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤...")

    server_ids = await get_server_ids_as_list(SERVEDATABASE)
    results = []

    for server_selection in server_ids:
        server_data = await get_server_data(server_selection)
        
        if not server_data:
            results.append(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞: {server_selection}.")
            continue

        try:
            session_id = await login(server_data['login_url'], {
                "username": server_data['username'],
                "password": server_data['password']
            })

            inactive_clients = await get_inactive_clients(server_data['list_clients_url'], session_id)
            results.append(f"–°–µ—Ä–≤–µ—Ä {server_data['name']}:\n{inactive_clients}")
            await scheduled_delete_clients()
            deleted_clients = await delete_depleted_clients(server_data['delete_depleted_clients_url'], session_id)
            results.append(f"–°–µ—Ä–≤–µ—Ä {server_data['name']}: {deleted_clients}")
        except Exception as e:
            results.append(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ {server_data['name']}: {str(e)}")

    await message.answer("\n".join(results))


@router.message(F.text == BUTTON_TEXTS["restart_bot"])
async def restart_bot(message: types.Message):
    """–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞."""
    await message.delete()
    await message.answer(
        "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞...\n"
        "‚è≥ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...",
        parse_mode=ParseMode.HTML
    )

    restart_command = ['sudo', 'systemctl', 'restart', 'bot.service']

    await asyncio.create_subprocess_exec(
        *restart_command,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE
    )


@router.message(F.text == BUTTON_TEXTS["backup"])
async def create_backup(message: types.Message):
    """–°–æ–∑–¥–∞–µ—Ç –±–µ–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –∞–¥–º–∏–Ω—É."""
    await message.delete()
    if message.from_user.id not in ADMIN_IDS:
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return

    backup_filename = f"backup_{datetime.now().strftime('%Y-%m-%d_%H-%M-%S')}.db"
    backup_path = os.path.join(BACKUP_DIR, backup_filename)

    try:
        shutil.copy(DATABASE_PATH, backup_path)
        logger.info(f"–ë–µ–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω: {backup_path}")
        await message.answer_document(
            document=FSInputFile(backup_path),
            caption=f"üíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: `{backup_filename}`",
            parse_mode="Markdown"
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–µ–∫–∞–ø–∞: {e}", exc_info=True)
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–µ–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
    finally:
        if os.path.exists(backup_path):
            os.remove(backup_path)
            logger.info(f"–í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –±–µ–∫–∞–ø–∞ —É–¥–∞–ª–µ–Ω: {backup_path}")
            

class AddPromoCodeState(StatesGroup):
    WaitingForCode = State()
    WaitingForDiscount = State()
    WaitingForDays = State()  # –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–≤–æ–¥–∞ –¥–Ω–µ–π

@router.message(F.text == BUTTON_TEXTS["add_promo_code"])
async def start_adding_promo_code(message: types.Message, state: FSMContext):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞, –æ—Ç–æ–±—Ä–∞–∂–∞—è —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤."""
    await message.delete()
    try:
        db = Database(USERSDATABASE) 
        db.cursor.execute('''SELECT code, discount, days FROM promo_codes WHERE is_active = 1''')
        promo_codes = db.cursor.fetchall()

        keyboard = InlineKeyboardBuilder()
        keyboard.add(
            InlineKeyboardButton(text=BUTTON_TEXTS["cancel"], callback_data="cancel_admin")
        )

        if promo_codes:
            promo_codes_list = "\n".join(
                [f"ü§ë –ü—Ä–æ–º–æ–∫–æ–¥: {promo_code[0]} - –°–∫–∏–¥–∫–∞: {promo_code[1]}% - –î–Ω–µ–π: {promo_code[2]}" 
                 for promo_code in promo_codes]
            )
            sent_message = await message.answer(
                f"–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã:\n{promo_codes_list}\n\n–í–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥:",
                reply_markup=keyboard.adjust(1).as_markup()
            )
        else:
            sent_message = await message.answer(
                "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤. –í–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥:",
                reply_markup=keyboard.adjust(1).as_markup()
            )

        await state.set_state(AddPromoCodeState.WaitingForCode)
        await state.update_data(sent_message_id=sent_message.message_id, chat_id=sent_message.chat.id)

    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: {e}")

@router.message(AddPromoCodeState.WaitingForCode)
async def process_promo_code(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–µ–¥—ë–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏."""
    promo_code = message.text.strip()
    if not promo_code:
        await message.answer("–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        return
        
    await state.update_data(promo_code=promo_code)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10 –¥–ª—è 10%):")
    await state.set_state(AddPromoCodeState.WaitingForDiscount)

@router.message(AddPromoCodeState.WaitingForDiscount)
async def process_discount(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–µ–¥—ë–Ω–Ω—É—é —Å–∫–∏–¥–∫—É –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π."""
    try:
        discount = int(message.text)
        if not (0 < discount <= 100):
            raise ValueError("–°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 100")
            
        await state.update_data(discount=discount)
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:")
        await state.set_state(AddPromoCodeState.WaitingForDays)
        
    except ValueError:
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100).")

@router.message(AddPromoCodeState.WaitingForDays)
async def process_days(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–µ–¥—ë–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥."""
    try:
        days = int(message.text)
        if days <= 0:
            raise ValueError("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")
            
        data = await state.get_data()
        promo_code = data["promo_code"]
        discount = data["discount"]

        try:
            db = Database(USERSDATABASE)
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            try:
                db.cursor.execute("ALTER TABLE promo_codes ADD COLUMN days INTEGER DEFAULT 30")
            except sqlite3.OperationalError:
                pass  # –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                
            db.cursor.execute('''
                INSERT INTO promo_codes (code, discount, days, is_active)
                VALUES (?, ?, ?, 1)
            ''', (promo_code, discount, days))
            db.connection.commit()
            
            await message.answer(
                f"‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ '{promo_code}' –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!\n"
                f"–°–∫–∏–¥–∫–∞: {discount}%\n"
                f"–î–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏: {days}"
            )
        except sqlite3.IntegrityError:
            await message.answer(f"‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ '{promo_code}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!")
        except Exception as e:
            await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞: {e}")
        finally:
            await state.clear()

    except ValueError:
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π (—Ü–µ–ª–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ).")

@router.message(F.text == BUTTON_TEXTS["delete_promo_code"])
async def start_deleting_promo_code(message: types.Message):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞, –æ—Ç–æ–±—Ä–∞–∂–∞—è —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤."""
    await message.delete()
    try:
        db = Database(USERSDATABASE)
        db.cursor.execute('''SELECT code, discount FROM promo_codes WHERE is_active = 1''')
        promo_codes = db.cursor.fetchall()

        if promo_codes:
            keyboard = InlineKeyboardBuilder()
            for promo_code in promo_codes:
                keyboard.add(
                    InlineKeyboardButton(
                        text=f"ü§ë {promo_code[0]} - {promo_code[1]}%",
                        callback_data=f"delete_{promo_code[0]}"
                    )
                )
            await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=keyboard.adjust(1).as_markup())
        else:
            await message.answer("‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: {e}")


@router.callback_query(lambda c: c.data.startswith("delete_"))
async def confirm_delete_promo_code(callback_query: types.CallbackQuery, state: FSMContext):
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞."""
    promo_code = callback_query.data.split("_")[1]
    await state.update_data(promo_code_to_delete=promo_code)

    keyboard = InlineKeyboardBuilder()
    keyboard.add(
        InlineKeyboardButton(text=BUTTON_TEXTS["confirm_delete"], callback_data="confirm_delete"),
        InlineKeyboardButton(text=BUTTON_TEXTS["no_delete"], callback_data="cancel_admin")
    )

    sent_message = await callback_query.message.edit_text(
        f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ '{promo_code}'?",
        reply_markup=keyboard.adjust(2).as_markup()
    )
    await state.update_data(sent_message_id=sent_message.message_id, chat_id=callback_query.message.chat.id)
    await state.set_state(ManagePromoCodeState.WaitingForDeleteConfirmation)


@router.callback_query(lambda c: c.data == "confirm_delete")
async def delete_promo_code(callback_query: types.CallbackQuery, state: FSMContext):
    """–£–¥–∞–ª—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è."""
    await state.set_state(ManagePromoCodeState.WaitingForDeleteConfirmation)

    data = await state.get_data()
    promo_code_to_delete = data.get("promo_code_to_delete")
    try:
        db = Database(USERSDATABASE)
        db.cursor.execute('''
            DELETE FROM promo_codes
            WHERE code = ?
        ''', (promo_code_to_delete,))
        db.connection.commit()
        await callback_query.message.edit_text(f"‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ '{promo_code_to_delete}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω!")
    except Exception as e:
        await callback_query.message.edit_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞: {e}")
    finally:
        await state.clear()
   
        
@router.message(Command("reset_ref"))
async def reset_referral_sum(message: types.Message):
    """–û–±–Ω—É–ª—è–µ—Ç —Å—É–º–º—É –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏ (sum_ref) —É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    await message.delete()

    if message.from_user.id not in ADMIN_IDS:
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.")
        return
    args = message.text.split()
    if len(args) < 2 or not args[1].isdigit():
        await message.answer("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–∏–º–µ—Ä:\n<code>/reset_ref 123456789</code>", parse_mode=ParseMode.HTML)
        return

    user_id = int(args[1])

    conn = sqlite3.connect(USERSDATABASE)
    cursor = conn.cursor()
    cursor.execute("SELECT telegram_link, sum_ref FROM users WHERE telegram_id = ?", (user_id,))
    user_data = cursor.fetchone()

    if not user_data:
        await message.answer("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.")
    else:
        telegram_link, sum_ref = user_data
        cursor.execute("UPDATE users SET sum_ref = 0 WHERE telegram_id = ?", (user_id,))
        conn.commit()

        await message.answer(
            f"‚úÖ <b>–û–±–Ω—É–ª–µ–Ω–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—É–º–º–∞</b>\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {telegram_link or 'N/A'} (<code>{user_id}</code>)\n"
            f"üí∏ <b>–ë—ã–ª–æ —Å–ø–∏—Å–∞–Ω–æ:</b> {sum_ref or 0} ‚ÇΩ",
            parse_mode=ParseMode.HTML,
            disable_web_page_preview=True
        )

    cursor.close()
    conn.close()
    
    
@router.callback_query(lambda c: c.data == "cluster_delete")
async def start_deleting_server_group(callback_query: types.CallbackQuery):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã —Å–µ—Ä–≤–µ—Ä–æ–≤, –æ—Ç–æ–±—Ä–∞–∂–∞—è —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø."""
    await callback_query.message.delete()

    db = Database(SERVEDATABASE)
    try:
        db.cursor.execute('SELECT group_name FROM server_groups')
        server_groups = db.cursor.fetchall()
        db.connection.close()

        if server_groups:
            keyboard = InlineKeyboardBuilder()
            for group in server_groups:
                keyboard.add(
                    InlineKeyboardButton(
                        text=f"üóÇ {group[0]}",
                        callback_data=f"cluster_delete_{group[0]}"
                    )
                )
            await callback_query.message.answer(
                "–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:",
                reply_markup=keyboard.adjust(1).as_markup()
            )
        else:
            await callback_query.message.answer("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
    except Exception as e:
        db.connection.close()
        await callback_query.message.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø: {e}")


@router.callback_query(lambda c: c.data.startswith("cluster_delete_"))
async def delete_server_group(callback_query: types.CallbackQuery):
    """–£–¥–∞–ª—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é –≥—Ä—É–ø–ø—É —Å–µ—Ä–≤–µ—Ä–æ–≤ –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è."""
    group_name = callback_query.data.split("_", 2)[2]

    db = Database(SERVEDATABASE)
    try:
        db.cursor.execute('DELETE FROM server_groups WHERE group_name = ?', (group_name,))
        db.connection.commit()
        db.connection.close()

        await callback_query.message.edit_text(f"‚úÖ –ì—Ä—É–ø–ø–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ '{group_name}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!")
    except Exception as e:
        db.connection.close()
        await callback_query.message.edit_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥—Ä—É–ø–ø—ã —Å–µ—Ä–≤–µ—Ä–æ–≤: {e}")

#–≤—Å–µ —Ä–µ—Ñ–µ—Ä–∞–ª—ã
class AddReferal(StatesGroup):
    waiting_for_name = State()

@router.message(F.text == BUTTON_TEXTS["referrals"])
async def show_referral_options(message: types.Message):
    kb = ReplyKeyboardBuilder()
    kb.row(
        types.KeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª"),
        types.KeyboardButton(text="üìã –í—Å–µ —Ä–µ—Ñ–µ—Ä–∞–ª—ã")
    )
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=kb.as_markup(resize_keyboard=True))

@router.message(F.text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª")
async def ask_for_referral_name(message: types.Message, state: FSMContext):
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞:")
    await state.set_state(AddReferal.waiting_for_name)

@router.message(AddReferal.waiting_for_name)
async def create_referral(message: types.Message, state: FSMContext, bot):
    name = message.text.strip()
    user_id = message.from_user.id
    code = ''.join(random.choices(string.ascii_letters + string.digits, k=10))

    conn = sqlite3.connect("users.db")
    cursor = conn.cursor()
    cursor.execute("INSERT INTO referals (user_id, name, code) VALUES (?, ?, ?)", (user_id, name, code))
    conn.commit()
    conn.close()

    bot_username = (await bot.get_me()).username
    link = f"https://t.me/{bot_username}?start={code}"

    await message.answer(f"‚úÖ –†–µ—Ñ–µ—Ä–∞–ª —Å–æ–∑–¥–∞–Ω: <b>{name}</b>\n–°—Å—ã–ª–∫–∞: {link}", parse_mode="HTML")
    await state.clear()

@router.message(F.text == "üìã –í—Å–µ —Ä–µ—Ñ–µ—Ä–∞–ª—ã")
async def list_all_referrals(message: types.Message):
    user_id = message.from_user.id

    conn = sqlite3.connect("users.db")
    cursor = conn.cursor()
    cursor.execute("SELECT name, code FROM referals WHERE user_id = ?", (user_id,))
    referals = cursor.fetchall()
    conn.close()

    if not referals:
        await message.answer("–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤.")
        return

    kb = InlineKeyboardBuilder()
    for name, code in referals:
        kb.add(InlineKeyboardButton(text=name, callback_data=f"ref_link:{code}"))

    await message.answer("–í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã:", reply_markup=kb.adjust(1).as_markup())

@router.callback_query(F.data.startswith("ref_link:"))
async def show_referral_details(callback: types.CallbackQuery):
    code = callback.data.split(":")[1]

    referral = await get_referral_info_by_code(code)
    
    if referral:
        await callback.answer("–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶", show_alert=False)
        name, code, clicks = referral

        async with aiosqlite.connect("users.db") as conn:
            # –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—É –ø–æ–∫—É–ø–æ–∫ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã referals
            cursor = await conn.execute(
                "SELECT amount FROM referals WHERE code = ?",
                (code,)
            )
            referral_data = await cursor.fetchone()
            total_amount = referral_data[0] if referral_data else 0

            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø–æ–¥–ø–∏—Å–∫–∞–º
            cursor = await conn.execute("""
                SELECT 
                    SUM(CASE WHEN has_trial = 1 AND (sum_my = 0 OR sum_my IS NULL) THEN 1 ELSE 0 END) as free_subs,
                    SUM(CASE WHEN sum_my > 0 THEN 1 ELSE 0 END) as paid_subs,
                    SUM(CASE WHEN has_trial = 0 AND (sum_my = 0 OR sum_my IS NULL) THEN 1 ELSE 0 END) as no_subs
                FROM users
                WHERE referrer_code = ?
            """, (code,))
            
            stats = await cursor.fetchone()
            free_count = stats[0] or 0
            paid_count = stats[1] or 0
            no_sub_count = stats[2] or 0

        bot_username = (await callback.bot.get_me()).username
        link = f"https://t.me/{bot_username}?start={code}"

        await callback.message.edit_text(
            f"<b>üë§ –†–µ—Ñ–µ—Ä–∞–ª:</b> {name}\n\n"
            f"<b>üîó –°—Å—ã–ª–∫–∞:</b> <code>{link}</code>\n"
            f"<b>üîó –†–µ—Ñ –∫–æ–¥:</b> <code>{code}</code>\n"
            f"<b>üë£ –ü–µ—Ä–µ—Ö–æ–¥–æ–≤:</b> {clicks}\n"
            f"<b>üí∏ –°—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫:</b> {total_amount} —Ä—É–±.\n\n"
            f"<b>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫:</b>\n"
            f"‚Ä¢ –ü—Ä–æ–±–Ω—ã–µ: {free_count}\n"
            f"‚Ä¢ –ü–ª–∞—Ç–Ω—ã–µ: {paid_count}\n"
            f"‚Ä¢ –ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏: {no_sub_count}",
            parse_mode="HTML",
            reply_markup=create_ref_stats_keyboard()
        )
    else:
        await callback.answer("‚ùå –†–µ—Ñ–µ—Ä–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)



def create_ref_stats_keyboard():
    kb = InlineKeyboardBuilder()
    kb.button(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="refresh_ref_stats")
    return kb.as_markup()

@router.message(F.text == BUTTON_TEXTS["days_sub"])
async def update_all_days_left_on_startup(message: types.Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç days_left –≤ user_configs —Å –¥–∞–Ω–Ω—ã–º–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–≤.
    """
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å —á–∞—Ç
    await message.delete()

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    sent_message = await message.answer(
        "üîÑ –ù–∞—á–∏–Ω–∞—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–æ–≤...\n"
        "‚è≥ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.",
        parse_mode=ParseMode.HTML
    )

    logger.info("üîÑ [sync_user_configs_with_servers] –ù–∞—á–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö email –∏–∑ user_configs...")

    # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ email –∏–∑ user_configs
    try:
        async with aiosqlite.connect("users.db") as conn:
            async with conn.execute("SELECT email FROM user_configs") as cursor:
                rows = await cursor.fetchall()
                emails = [row[0] for row in rows]
        logger.info(f"üìÅ –ù–∞–π–¥–µ–Ω–æ {len(emails)} email'–æ–≤ –≤ user_configs: {emails}")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è user_configs: {e}")
        await sent_message.edit_text(
            "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã.\n"
            "–ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ –ª–æ–≥–∞—Ö.",
            parse_mode=ParseMode.HTML
        )
        return

    if not emails:
        logger.info("üì≠ –ù–µ—Ç email'–æ–≤ –≤ user_configs ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞.")
        await sent_message.edit_text(
            "üì≠ –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.",
            parse_mode=ParseMode.HTML
        )
        return

    # –®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ ID —Å–µ—Ä–≤–µ—Ä–æ–≤
    try:
        server_ids = await get_server_ids_as_list_for_days_left("servers.db")
        if not server_ids:
            logger.warning("üì≠ –ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.")
            await sent_message.edit_text(
                "üì≠ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.",
                parse_mode=ParseMode.HTML
            )
            return
        logger.info(f"üåê –ù–∞–π–¥–µ–Ω–æ {len(server_ids)} —Å–µ—Ä–≤–µ—Ä–æ–≤: {server_ids}")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤: {e}")
        await sent_message.edit_text(
            "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤.",
            parse_mode=ParseMode.HTML
        )
        return

    updated_count = 0

    # –®–∞–≥ 3: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–µ—Ä –æ—Ç–¥–µ–ª—å–Ω–æ
    for server_id in server_ids:
        logger.info(f"üîÅ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ID={server_id}")

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞
        server_data = await get_server_data(server_id)
        if not server_data:
            logger.warning(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞ {server_id}")
            continue

        logger.info(f"üåê –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É {server_id} ({server_data['name']})")

        # –°–æ–∑–¥–∞—ë–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Å–µ—Å—Å–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        async with aiohttp.ClientSession() as session:
            try:
                # –õ–æ–≥–∏–Ω–∏–º—Å—è
                login_data = {
                    "username": server_data["username"],
                    "password": server_data["password"]
                }
                async with session.post(server_data["login_url"], json=login_data) as login_resp:
                    if login_resp.status != 200:
                        text = await login_resp.text()
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä {server_id}: {text}")
                        continue

                    cookies = login_resp.cookies
                    session_id = cookies.get('3x-ui').value
                    if not session_id:
                        logger.error(f"‚ùå –ù–µ –ø–æ–ª—É—á–µ–Ω session_id —Å —Å–µ—Ä–≤–µ—Ä–∞ {server_id}")
                        continue

                    headers = {'Accept': 'application/json', 'Cookie': f'3x-ui={session_id}'}

                found_any = False  # –§–ª–∞–≥: –Ω–∞–π–¥–µ–Ω –ª–∏ —Ö–æ—Ç—å –æ–¥–∏–Ω email –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ

                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π inbound
                for inbound_id in server_data["inbound_ids"]:
                    url = f"{server_data['config_client_url']}/{inbound_id}"
                    logger.info(f"üîç –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º inbound {inbound_id} –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ {server_id}")

                    try:
                        async with session.get(url, headers=headers) as resp:
                            if resp.status != 200:
                                text = await resp.text()
                                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è inbound {inbound_id}: {text}")
                                continue

                            data = await resp.json()
                            obj = data.get('obj')
                            if not obj:
                                logger.warning(f"‚ö†Ô∏è –ü—É—Å—Ç–æ–π obj –≤ –æ—Ç–≤–µ—Ç–µ inbound {inbound_id}")
                                continue

                            settings = obj.get('settings')
                            if not settings:
                                logger.warning(f"‚ö†Ô∏è –ù–µ—Ç settings –≤ inbound {inbound_id}")
                                continue

                            try:
                                clients = json.loads(settings).get('clients', [])
                            except Exception as e:
                                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ clients: {e}")
                                continue

                            logger.info(f"üì• –°–µ—Ä–≤–µ—Ä {server_id}, inbound {inbound_id}: –ø–æ–ª—É—á–µ–Ω–æ {len(clients)} –∫–ª–∏–µ–Ω—Ç–æ–≤")

                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
                            for client in clients:
                                email = client.get('email')
                                expiry_time = client.get('expiryTime')

                                if not email:
                                    logger.debug(f"üü° –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –±–µ–∑ email: {client}")
                                    continue

                                if email in emails:
                                    found_any = True

                                    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º days_left
                                    if expiry_time is None or expiry_time <= 0:
                                        days_left = -1
                                        status = "–Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞"
                                    else:
                                        expiry_dt = datetime.fromtimestamp(expiry_time / 1000)
                                        days_left = (expiry_dt.date() - datetime.now().date()).days
                                        status = f"–æ—Å—Ç–∞–ª–æ—Å—å {days_left} –¥–Ω."

                                    logger.info(f"üéØ –ù–ê–ô–î–ï–ù: {email} –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ {server_id} ‚Üí expiry_time={expiry_time}, —Å—Ç–∞—Ç—É—Å: {status}")

                                    # –û–±–Ω–æ–≤–ª—è–µ–º –≤ user_configs
                                    try:
                                        async with aiosqlite.connect("users.db") as conn:
                                            await conn.execute(
                                                "UPDATE user_configs SET days_left = ? WHERE email = ?",
                                                (days_left, email)
                                            )
                                            await conn.commit()
                                        logger.info(f"‚úÖ [—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è] {email} ‚Üí days_left = {days_left}")
                                        updated_count += 1
                                    except Exception as e:
                                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è {email} –≤ –ë–î: {e}")

                                else:
                                    logger.debug(f"‚ÑπÔ∏è email={email} –µ—Å—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ user_configs")

                    except Exception as e:
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ inbound {inbound_id}: {e}")

                if not found_any:
                    logger.warning(f"üü° –ù–∏ –æ–¥–∏–Ω –∏–∑ {len(emails)} email'–æ–≤ –ù–ï –ù–ê–ô–î–ï–ù –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ {server_id}")

            except Exception as e:
                logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º {server_id}: {e}")

    logger.info(f"‚úÖ [sync_user_configs_with_servers] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û–±–Ω–æ–≤–ª–µ–Ω–æ {updated_count} –∑–∞–ø–∏—Å–µ–π.")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await sent_message.edit_text(
        f"‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n"
        f"üìä –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: <b>{updated_count}</b>\n"
        f"üîç –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ email'–æ–≤: <b>{len(emails)}</b>\n"
        f"üåê –ù–∞ {len(server_ids)} —Å–µ—Ä–≤–µ—Ä–∞—Ö.",
        parse_mode=ParseMode.HTML
    )

"""–ë–ª–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
class AdminUserSearch(StatesGroup):
    waiting_for_user_identifier = State()

@router.message(F.text == BUTTON_TEXTS["edit_users"])
async def edit_users_handler(message: Message, state: FSMContext):
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ID –∏–ª–∏ —Å—Å—ã–ª–∫—É)"""
    await message.delete()

    if message.from_user.id not in ADMIN_IDS:
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —Ä–∞–∑–¥–µ–ª—É.")
        return

    sent_message = await message.answer(
        "üÜî –í–≤–µ–¥–∏—Ç–µ <b>Telegram ID</b> –∏–ª–∏ <b>@username</b> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å –∫–æ—Ç–æ—Ä—ã–º —Ö–æ—Ç–∏—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å:"
    )

    await state.update_data(sent_message_id=sent_message.message_id, chat_id=sent_message.chat.id)
    await state.set_state(AdminUserSearch.waiting_for_user_identifier)

@router.message(AdminUserSearch.waiting_for_user_identifier)
async def process_user_identifier(message: Message, state: FSMContext):
    identifier = message.text.strip().lower()

    if not identifier:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä.")
        return

    # –ò–∑–≤–ª–µ–∫–∞–µ–º username
    if identifier.startswith("@"):
        search_username = identifier[1:]
    elif "t.me/" in identifier:
        search_username = identifier.split("t.me/")[-1].split("?")[0]
    else:
        search_username = identifier.strip()

    if not search_username:
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    pattern = f"%t.me/{search_username}%"

    async with aiosqlite.connect("users.db") as conn:
        cursor = await conn.cursor()
        await cursor.execute("SELECT * FROM users WHERE LOWER(telegram_link) LIKE ?", (pattern,))
        row = await cursor.fetchone()

        if row:
            columns = [desc[0] for desc in cursor.description]
            user_data = dict(zip(columns, row))
        else:
            user_data = None

    if not user_data:
        await message.answer(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Å—Å—ã–ª–∫–æ–π <code>t.me/{search_username}</code> –Ω–µ –Ω–∞–π–¥–µ–Ω.", parse_mode="HTML")
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await state.update_data(target_user=user_data)

    # –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: —Ç–æ–ª—å–∫–æ Telegram ID –∏ Username
    user_preview = (
        "üë§ <b>–í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b>\n\n"
        f"üîπ <b>Telegram ID:</b> <code>{user_data['telegram_id']}</code>\n"
        f"üîπ <b>Username:</b> @{user_data['username'] or '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n"
    )

    # –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    user_actions_keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=BUTTON_TEXTS["info_for_admin"], callback_data="user_info_for_admin")],
        [InlineKeyboardButton(text=BUTTON_TEXTS["prodlit_podpisku"], callback_data="prodlit_podpisku")],
        [InlineKeyboardButton(text=BUTTON_TEXTS["statistics_for_admin"], callback_data="user_stats_for_admin")],
        [InlineKeyboardButton(text=BUTTON_TEXTS["block_user"], callback_data="block_user")],
        [InlineKeyboardButton(text=BUTTON_TEXTS["udalit_user"], callback_data="udalit_user")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_admin")]
    ])

    await message.answer(user_preview, reply_markup=user_actions_keyboard, parse_mode="HTML")
    await state.set_state(None)

@router.callback_query(lambda call: call.data == "user_info_for_admin")
async def user_info_callback_for_admin(call: types.CallbackQuery, state: FSMContext):
    await call.answer()

    data = await state.get_data()
    user_data = data.get("target_user")

    if not user_data:
        await call.message.edit_text("‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Ç–µ—Ä—è–Ω—ã. –ù–∞—á–Ω–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞.")
        return

    full_info_text = (
        "üìò <b>–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</b>\n\n"
        f"üîπ <b>ID –≤ –ë–î:</b> {user_data['id']}\n"
        f"üîπ <b>Telegram ID:</b> <code>{user_data['telegram_id']}</code>\n"
        f"üîπ <b>Username:</b> @{user_data['username'] or '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n"
        f"üîπ <b>–°—Å—ã–ª–∫–∞:</b> {user_data['telegram_link'] or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n"
        f"üîπ <b>–†–µ—Ñ. –∫–æ–¥:</b> <code>{user_data['referral_code']}</code>\n"
        f"üîπ <b>–ü–æ–ª—É—á–∞–ª –ø—Ä–æ–±–Ω—É—é:</b> {'–î–∞' if user_data['has_trial'] else '–ù–µ—Ç'}\n"
        f"üîπ <b>–î–æ—Ö–æ–¥ (sum_my):</b> {user_data['sum_my']:.2f} —Ä—É–±.\n"
        f"üîπ <b>–ü—Ä–∏–≥–ª–∞—Å–∏–ª (referrer_code):</b> {user_data['referrer_code'] or '‚Äî'}\n"
        f"üîπ <b>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω:</b> {'–î–∞' if user_data['is_blocked'] else '–ù–µ—Ç'}\n"
    )

    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤–µ–¥—ë—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π
    back_keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_actions")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_admin")]
    ])

    await call.message.edit_text(full_info_text, reply_markup=back_keyboard, parse_mode="HTML")


@router.callback_query(lambda call: call.data == "prodlit_podpisku")
async def prodlit_podpisku(call: types.CallbackQuery):
    await call.answer()
    await call.message.edit_text("üí≥ –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.")


@router.callback_query(lambda call: call.data == "user_stats_for_admin")
async def user_stats_callback_for_admin(call: types.CallbackQuery):
    await call.answer()
    await call.message.edit_text("üìä –í–≤–µ–¥–∏—Ç–µ id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.")


@router.callback_query(lambda call: call.data == "block_user")
async def block_user(call: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    target_user = data.get("target_user")

    if not target_user:
        await call.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω.", show_alert=True)
        return

    if target_user['is_blocked']:
        await call.message.edit_text("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.")
        return

    confirm_kb = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="‚úÖ –î–∞, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data="confirm_block_user"),
            InlineKeyboardButton(text="‚ùå –ù–µ—Ç", callback_data="cancel_admin")
        ]
    ])

    await call.message.edit_text(
        f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
        f"<b>{target_user['username']}</b> (ID: {target_user['telegram_id']})?",
        reply_markup=confirm_kb,
        parse_mode="HTML"
    )
    await call.answer()


@router.callback_query(lambda call: call.data == "confirm_block_user")
async def confirm_block_user(call: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    target_user = data.get("target_user")

    async with aiosqlite.connect("users.db") as conn:
        await conn.execute(
            "UPDATE users SET is_blocked = 1 WHERE telegram_id = ?",
            (target_user['telegram_id'],)
        )
        await conn.commit()

    await call.message.edit_text(
        f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å <code>{target_user['telegram_id']}</code> —É—Å–ø–µ—à–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.",
        parse_mode="HTML"
    )
    await call.answer()


@router.callback_query(lambda call: call.data == "udalit_user")
async def udalit_user(call: types.CallbackQuery):
    await call.answer()
    await call.message.edit_text("üóëÔ∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")

@router.callback_query(lambda call: call.data == "back_to_actions")
async def back_to_actions(call: types.CallbackQuery, state: FSMContext):
    await call.answer()

    data = await state.get_data()
    user_data = data.get("target_user")

    if not user_data:
        await call.message.edit_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–∞—á–Ω–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞.")
        return

    user_preview = (
        "üë§ <b>–í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b>\n\n"
        f"üîπ <b>Telegram ID:</b> <code>{user_data['telegram_id']}</code>\n"
        f"üîπ <b>Username:</b> @{user_data['username'] or '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n"
    )

    user_actions_keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=BUTTON_TEXTS["info_for_admin"], callback_data="user_info_for_admin")],
        [InlineKeyboardButton(text=BUTTON_TEXTS["prodlit_podpisku"], callback_data="prodlit_podpisku")],
        [InlineKeyboardButton(text=BUTTON_TEXTS["statistics_for_admin"], callback_data="user_stats_for_admin")],
        [InlineKeyboardButton(text=BUTTON_TEXTS["block_user"], callback_data="block_user")],
        [InlineKeyboardButton(text=BUTTON_TEXTS["udalit_user"], callback_data="udalit_user")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_admin")]
    ])

    await call.message.edit_text(user_preview, reply_markup=user_actions_keyboard, parse_mode="HTML")